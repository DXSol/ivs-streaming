<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/events"></ion-back-button>
    </ion-buttons>
    <ion-title class="heading">{{ isRecordingMode ? 'Watch Recording' : 'Live Concert' }}</ion-title>
    <ion-buttons slot="end">
      <ion-button class="toolbar-icon-btn" fill="clear" routerLink="/events">
        <ion-icon name="home-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content>
  <!-- Diagnostic Panel Toggle Button (visible when debug mode is active) -->
  <button
    *ngIf="debugMode"
    class="diagnostic-toggle-btn"
    [class.has-anomalies]="anomalyCount > 0"
    (click)="toggleDiagnosticPanel()"
  >
    {{ showDiagnosticPanel ? '‚úï' : 'üîß' }}
    <span *ngIf="anomalyCount > 0" class="anomaly-badge">{{ anomalyCount }}</span>
  </button>

  <!-- Diagnostic Panel -->
  <div *ngIf="debugMode && showDiagnosticPanel" class="diagnostic-panel">
    <div class="diagnostic-header">
      <h3>IVS Player Diagnostics</h3>
      <div class="diagnostic-actions">
        <button class="diag-btn" (click)="clearDiagnosticLog()" title="Clear log">Clear</button>
        <button class="diag-btn" (click)="exportDiagnosticLog()" title="Export to JSON">Export</button>
        <button class="diag-btn close" (click)="toggleDiagnosticPanel()" title="Close panel">‚úï</button>
      </div>
    </div>

    <!-- Real-time Metrics -->
    <div class="diagnostic-section">
      <h4>Real-time Metrics</h4>
      <div class="metrics-grid">
        <div class="metric">
          <span class="metric-label">Position</span>
          <span class="metric-value">{{ currentMetrics.position.toFixed(2) }}s</span>
        </div>
        <div class="metric">
          <span class="metric-label">Buffer</span>
          <span class="metric-value" [class.warning]="currentMetrics.bufferDuration < 3">
            {{ currentMetrics.bufferDuration.toFixed(2) }}s
          </span>
        </div>
        <div class="metric">
          <span class="metric-label">Quality</span>
          <span class="metric-value">{{ currentMetrics.quality }}</span>
        </div>
        <div class="metric">
          <span class="metric-label">Bitrate</span>
          <span class="metric-value">{{ (currentMetrics.bitrate / 1000000).toFixed(2) }} Mbps</span>
        </div>
        <div class="metric">
          <span class="metric-label">Ready State</span>
          <span class="metric-value">{{ currentMetrics.readyState }}</span>
        </div>
        <div class="metric">
          <span class="metric-label">Network State</span>
          <span class="metric-value">{{ currentMetrics.networkState }}</span>
        </div>
      </div>
    </div>

    <!-- Token Status -->
    <div class="diagnostic-section">
      <h4>Token Status</h4>
      <div class="metrics-grid">
        <div class="metric wide">
          <span class="metric-label">Next Refresh In</span>
          <span class="metric-value" [class.warning]="tokenStatus.timeUntilRefresh < 60">
            {{ tokenStatus.timeUntilRefresh }}s
          </span>
        </div>
        <div class="metric">
          <span class="metric-label">Refresh Count</span>
          <span class="metric-value">{{ tokenStatus.refreshCount }}</span>
        </div>
        <div class="metric" *ngIf="tokenStatus.lastRefreshAt">
          <span class="metric-label">Last Refresh</span>
          <span class="metric-value">{{ formatDiagnosticTime(tokenStatus.lastRefreshAt) }}</span>
        </div>
        <div class="metric" *ngIf="tokenStatus.positionBeforeRefresh !== null">
          <span class="metric-label">Pos Before</span>
          <span class="metric-value">{{ tokenStatus.positionBeforeRefresh?.toFixed(2) }}s</span>
        </div>
        <div class="metric" *ngIf="tokenStatus.positionAfterRefresh !== null">
          <span class="metric-label">Pos After</span>
          <span class="metric-value">{{ tokenStatus.positionAfterRefresh?.toFixed(2) }}s</span>
        </div>
      </div>
    </div>

    <!-- Anomaly Summary -->
    <div class="diagnostic-section" *ngIf="anomalyCount > 0">
      <h4 class="anomaly-header">Anomalies Detected: {{ anomalyCount }}</h4>
    </div>

    <!-- Event Log -->
    <div class="diagnostic-section event-log-section">
      <h4>Event Log ({{ diagnosticEvents.length }})</h4>
      <div class="event-log">
        <div
          *ngFor="let event of diagnosticEvents"
          class="log-entry"
          [ngClass]="getDiagnosticEventClass(event)"
        >
          <span class="log-time">{{ formatDiagnosticTime(event.timestamp) }}</span>
          <span class="log-type">[{{ event.type.toUpperCase() }}]</span>
          <span class="log-message">{{ event.message }}</span>
          <span *ngIf="event.data" class="log-data">{{ event.data | json }}</span>
        </div>
        <div *ngIf="diagnosticEvents.length === 0" class="no-events">
          No events logged yet
        </div>
      </div>
    </div>
  </div>

  <div class="watch-layout">
    <!-- Main Content (Video + Event Info) -->
    <div class="main-column">
      <!-- Video Player (IVS for paid events and recordings) -->
      <div class="player-shell" [hidden]="event?.event_type === 'free' || event?.event_type === 'free-short'">
        <video
          #videoEl
          class="video"
          playsinline
          autoplay
          controls
          (click)="resumePlayback()"
        ></video>

        <!-- Loading State -->
        <div *ngIf="isLoading" class="overlay">
          <div class="overlay-content">
            <div class="spinner"></div>
            <p>Loading stream...</p>
          </div>
        </div>

        <!-- Offline State -->
        <div *ngIf="!isLoading && streamStatus === 'offline'" class="overlay offline">
          <div class="overlay-content">
            <span class="status-icon">üì∫</span>
            <p>Stream has ended or is not available.</p>
          </div>
        </div>

        <!-- Error State -->
        <div *ngIf="!isLoading && streamStatus === 'error' && errorMessage" class="overlay error">
          <div class="overlay-content">
            <span class="status-icon">‚ö†Ô∏è</span>
            <p>{{ errorMessage }}</p>
            <ion-button size="small" (click)="ngOnInit()">Try Again</ion-button>
          </div>
        </div>

        <!-- Device Limit State -->
        <div *ngIf="!isLoading && streamStatus === 'device-limit'" class="overlay device-limit">
          <div class="overlay-content">
            <span class="status-icon">üì±</span>
            <h3>Device Limit Reached</h3>
            <p>{{ deviceLimitMessage }}</p>
            <p class="hint">You can watch from a maximum of {{ maxDevices }} devices at a time.</p>
            <ion-button size="small" routerLink="/events">Back to Events</ion-button>
          </div>
        </div>

        <!-- Live Badge -->
        <div *ngIf="streamStatus === 'live'" class="live-indicator">
          <span class="live-badge">‚óè LIVE</span>
        </div>

        <!-- Quality Adjustment Notification -->
        <div *ngIf="showQualityNotification" class="quality-notification">
          <span class="quality-notification-icon">‚öôÔ∏è</span>
          <span class="quality-notification-message">{{ qualityNotificationMessage }}</span>
        </div>

        <!-- Recording Badge with Session Info -->
        <div *ngIf="streamStatus === 'recording'" class="live-indicator">
          <span class="recording-badge">‚óè RECORDING</span>
          <span *ngIf="totalSessions > 1" class="session-info">
            Part {{ currentSessionIndex + 1 }} of {{ totalSessions }}
          </span>
        </div>

        <!-- Recording Ended -->
        <div *ngIf="streamStatus === 'ended'" class="overlay">
          <div class="overlay-content">
            <p>Recording playback complete</p>
            <ion-button size="small" (click)="playSession(0)">Watch Again</ion-button>
            <ion-button size="small" routerLink="/events">Back to Events</ion-button>
          </div>
        </div>
      </div>

      <!-- Session Navigation (for multi-session recordings) -->
      <div *ngIf="isRecordingMode && totalSessions > 1 && !isLoading" class="session-nav">
        <div class="session-nav-header">
          <span class="session-nav-title">Recording Sessions ({{ totalSessions }})</span>
        </div>
        <div class="session-list">
          <button 
            *ngFor="let session of recordingSessions; let i = index"
            class="session-btn"
            [class.active]="i === currentSessionIndex"
            (click)="playSession(i)"
          >
            <span class="session-num">{{ i + 1 }}</span>
            <span class="session-time" *ngIf="session.timestamp">{{ session.timestamp }}</span>
          </button>
        </div>
      </div>

      <!-- YouTube Player (for free and free-short events) -->
      <div class="player-shell youtube-player" *ngIf="event?.event_type === 'free' || event?.event_type === 'free-short'">
        <iframe
          *ngIf="getYouTubeEmbedUrl()"
          [src]="getYouTubeEmbedUrl()"
          class="video"
          frameborder="0"
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
          allowfullscreen
        ></iframe>

        <!-- Loading State -->
        <div *ngIf="isLoading" class="overlay">
          <div class="overlay-content">
            <div class="spinner"></div>
            <p>Loading video...</p>
          </div>
        </div>

        <!-- Free Event Badge - Show RECORDING for past events, FREE for live -->
        <div *ngIf="!isLoading" class="live-indicator">
          <span *ngIf="isPastEvent" class="recording-badge">‚óè RECORDING</span>
          <span *ngIf="!isPastEvent" class="free-badge">FREE</span>
        </div>
      </div>

      <!-- Event Info Section (YouTube-like) -->
      <div *ngIf="!isLoading && event" class="event-info">
        <h1 class="event-title">{{ event.title }}</h1>
        <div class="event-meta">
          <div class="meta-item">
            <span class="meta-icon">üìÖ</span>
            <span>{{ event.starts_at | eventTime:'full' }}</span>
          </div>
          <div class="meta-item" *ngIf="viewerCount > 0">
            <span class="meta-icon">üëÅ</span>
            <span>{{ viewerCount }} watching</span>
          </div>
        </div>
        <div class="event-actions">
          <ion-button fill="outline" size="small" (click)="shareEvent()">
            üì§ Share
          </ion-button>
        </div>
        <p class="event-description" *ngIf="event.description">{{ event.description }}</p>
      </div>
    </div>

    <!-- Comments Sidebar -->
    <div *ngIf="!isLoading" class="comments-column">
      <div class="comments-header">
        <h2 class="comments-title">Comments</h2>
        <span class="comments-count" *ngIf="comments.length">{{ comments.length }} comments</span>
      </div>

      <div class="yt-composer">
        <div class="avatar">{{ getEventAvatarInitial() }}</div>
        <div class="composer-right">
          <ion-item class="composer-input" lines="none">
            <ion-textarea
              [(ngModel)]="commentText"
              autoGrow="true"
              placeholder="Add a comment..."
            ></ion-textarea>
          </ion-item>

          <div class="emoji-bar">
            <button *ngFor="let emoji of quickEmojis" class="emoji-btn" (click)="addEmoji(emoji.char)" [title]="emoji.name">
              {{ emoji.char }}
            </button>
          </div>

          <div class="composer-actions">
            <ion-button
              size="small"
              (click)="submitComment()"
              [disabled]="isSubmittingComment || !commentText.trim()"
            >
              Post Comment
            </ion-button>
          </div>
        </div>
      </div>

      <div *ngIf="!comments.length" class="comments-empty">
        üéµ Be the first to share your thoughts on this performance
      </div>

      <div *ngIf="comments.length" class="comments-list">
        <div class="yt-comment" *ngFor="let c of comments">
          <div class="avatar small">{{ (c.user_name || c.user_email || 'U').slice(0,1).toUpperCase() }}</div>
          <div class="comment-right">
            <div class="comment-meta">
              <span class="comment-user">{{ c.user_name || c.user_email }}</span>
              <span class="comment-time">{{ c.created_at | date:'short' }}</span>
            </div>
            <div class="comment-body">{{ c.body }}</div>
          </div>
        </div>
      </div>
    </div>

    <app-footer></app-footer>
  </div>
</ion-content>
