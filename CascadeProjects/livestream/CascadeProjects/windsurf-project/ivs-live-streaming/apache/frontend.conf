# ============================================
# OLD DOMAIN - Redirect to new domain
# ============================================
<VirtualHost *:80>
    ServerName events.edifyplus.com
    
    # Redirect to new domain
    RewriteEngine On
    RewriteRule ^(.*)$ https://events.sampradaya.live$1 [L,R=301]
</VirtualHost>

<VirtualHost *:443>
    ServerName events.edifyplus.com

    # SSL Configuration (keep old cert for redirect)
    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/events.edifyplus.com/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/events.edifyplus.com/privkey.pem

    # Redirect to new domain
    RewriteEngine On
    RewriteRule ^(.*)$ https://events.sampradaya.live$1 [L,R=301]
</VirtualHost>

# ============================================
# NEW DOMAIN - Serve frontend
# ============================================
<VirtualHost *:80>
    ServerName events.sampradaya.live
    
    # Redirect HTTP to HTTPS
    RewriteEngine On
    RewriteCond %{HTTPS} off
    RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
</VirtualHost>

<VirtualHost *:443>
    ServerName events.sampradaya.live
    DocumentRoot /data/www/ivs-streaming/frontend

    # SSL Configuration
    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/events.sampradaya.live/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/events.sampradaya.live/privkey.pem

    # Enable required modules: mod_proxy, mod_proxy_http, mod_rewrite, mod_headers
    
    # Gzip compression
    <IfModule mod_deflate.c>
        AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css
        AddOutputFilterByType DEFLATE application/javascript application/json
        AddOutputFilterByType DEFLATE application/xml application/xhtml+xml
    </IfModule>

    # Frontend static files
    <Directory /data/www/ivs-streaming/frontend>
        Options -Indexes +FollowSymLinks
        AllowOverride None
        Require all granted
    </Directory>

    # Angular SPA routing - fallback to index.html for all non-file/non-api routes
    RewriteEngine On
    
    # Don't rewrite API requests
    RewriteCond %{REQUEST_URI} !^/api
    # Don't rewrite if file exists
    RewriteCond %{DOCUMENT_ROOT}%{REQUEST_URI} !-f
    # Don't rewrite if directory exists
    RewriteCond %{DOCUMENT_ROOT}%{REQUEST_URI} !-d
    # Rewrite everything else to index.html
    RewriteRule ^(.*)$ /index.html [L]

    # Proxy API requests to backend
    ProxyPreserveHost On
    ProxyPass /api https://events-backend.edifyplus.com/api
    ProxyPassReverse /api https://events-backend.edifyplus.com/api

    # WebSocket support (if needed)
    RewriteEngine On
    RewriteCond %{HTTP:Upgrade} websocket [NC]
    RewriteCond %{HTTP:Connection} upgrade [NC]
    RewriteRule ^/api/(.*) ws://localhost:5050/api/$1 [P,L]

    # Security headers
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"

    # Cache static assets
    <FilesMatch "\.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$">
        Header set Cache-Control "public, max-age=31536000, immutable"
    </FilesMatch>

    # Error logs
    ErrorLog ${APACHE_LOG_DIR}/ivs-streaming-error.log
    CustomLog ${APACHE_LOG_DIR}/ivs-streaming-access.log combined
</VirtualHost>
