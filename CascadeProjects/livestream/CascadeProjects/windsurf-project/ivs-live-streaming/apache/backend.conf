# Backend API Virtual Host (Optional - if running backend on separate subdomain)
# This is only needed if you want to expose the backend directly
# Otherwise, the frontend.conf handles API proxying via /api path

<VirtualHost *:80>
    ServerName events-backend.edifyplus.com
    
    # Redirect HTTP to HTTPS
    RewriteEngine On
    RewriteCond %{HTTPS} off
    RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
</VirtualHost>

<VirtualHost *:443>
    ServerName events-backend.edifyplus.com

    # SSL Configuration
    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/events-backend.edifyplus.com/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/events-backend.edifyplus.com/privkey.pem

    # Proxy all requests to Node.js backend
    ProxyPreserveHost On
    ProxyPass / http://localhost:5050/
    ProxyPassReverse / http://localhost:5050/

    # WebSocket support
    RewriteEngine On
    RewriteCond %{HTTP:Upgrade} websocket [NC]
    RewriteCond %{HTTP:Connection} upgrade [NC]
    RewriteRule ^/(.*) ws://localhost:5050/$1 [P,L]

    # CORS headers - backend CORS is disabled in production
    <IfModule mod_headers.c>
        Header always set Access-Control-Allow-Origin "https://events.sampradaya.live"
        Header always set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, PATCH, OPTIONS"
        Header always set Access-Control-Allow-Headers "Authorization, Content-Type, Accept, Origin, X-Requested-With"
        Header always set Access-Control-Allow-Credentials "true"
        Header always set Access-Control-Max-Age "3600"
    </IfModule>

    # Handle preflight OPTIONS requests
    RewriteCond %{REQUEST_METHOD} OPTIONS
    RewriteRule ^(.*)$ $1 [R=204,L]

    # Security headers
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-Frame-Options "DENY"

    # Error logs
    ErrorLog ${APACHE_LOG_DIR}/ivs-api-error.log
    CustomLog ${APACHE_LOG_DIR}/ivs-api-access.log combined
</VirtualHost>
