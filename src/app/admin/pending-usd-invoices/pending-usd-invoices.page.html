<ion-header>
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/admin/dashboard"></ion-back-button>
    </ion-buttons>
    <ion-title>Pending USD Invoices</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="loadPendingInvoices()" [disabled]="isLoading">
        <ion-spinner *ngIf="isLoading" name="crescent"></ion-spinner>
        <span *ngIf="!isLoading">Refresh</span>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  <div class="page-header">
    <h1>Pending USD Payment Invoices</h1>
    <p class="subtitle">Create invoices for international payments by entering the USD to INR exchange rate</p>
  </div>

  <div *ngIf="errorMessage" class="error-banner">
    {{ errorMessage }}
  </div>

  <div *ngIf="isLoading" class="loading-container">
    <ion-spinner name="crescent"></ion-spinner>
    <p>Loading pending invoices...</p>
  </div>

  <div *ngIf="!isLoading && pendingInvoices.length === 0" class="empty-state">
    <h2>No Pending USD Invoices</h2>
    <p>All USD payments have been processed or no USD payments have been received yet.</p>
    <ion-button routerLink="/admin/dashboard" fill="outline">
      Back to Dashboard
    </ion-button>
  </div>

  <div *ngIf="!isLoading && pendingInvoices.length > 0" class="invoices-list">
    <ion-card *ngFor="let invoice of pendingInvoices" class="invoice-card">
      <ion-card-header>
        <ion-card-title>
          {{ invoice.user_name }}
          <span class="payment-badge">{{ getInvoiceTypeLabel(invoice.invoice_type) }}</span>
        </ion-card-title>
      </ion-card-header>

      <ion-card-content>
        <div class="invoice-details">
          <div class="detail-row">
            <span class="label">Customer Email:</span>
            <span class="value">{{ invoice.user_email }}</span>
          </div>

          <div class="detail-row" *ngIf="invoice.event_title">
            <span class="label">Event:</span>
            <span class="value">{{ invoice.event_title }}</span>
          </div>

          <div class="detail-row">
            <span class="label">Payment ID:</span>
            <span class="value code">{{ invoice.provider_payment_id }}</span>
          </div>

          <div class="detail-row">
            <span class="label">Payment Date:</span>
            <span class="value">{{ formatDate(invoice.created_at) }}</span>
          </div>

          <div class="detail-row highlight">
            <span class="label">Amount (USD):</span>
            <span class="value">${{ (invoice.amount_cents / 100).toFixed(2) }}</span>
          </div>

          <div class="exchange-rate-section">
            <ion-item>
              <ion-label position="stacked">Exchange Rate (USD to INR)</ion-label>
              <ion-input
                type="number"
                step="0.01"
                min="0"
                [value]="getExchangeRate(invoice.payment_id)"
                (ionInput)="setExchangeRate(invoice.payment_id, $event.target.value)"
                [disabled]="isProcessing(invoice.payment_id)"
              ></ion-input>
            </ion-item>

            <div class="calculated-amount">
              <span class="label">INR Amount:</span>
              <span class="value">â‚¹{{ getInrAmount(invoice.amount_cents, invoice.payment_id).toFixed(2) }}</span>
            </div>
          </div>

          <ion-button
            expand="block"
            color="primary"
            (click)="createInvoice(invoice)"
            [disabled]="isProcessing(invoice.payment_id)"
          >
            <ion-spinner *ngIf="isProcessing(invoice.payment_id)" name="crescent"></ion-spinner>
            <span *ngIf="!isProcessing(invoice.payment_id)">Create Invoice</span>
          </ion-button>
        </div>
      </ion-card-content>
    </ion-card>
  </div>
</ion-content>
